# https://losst.ru/rezervnoe-kopirovanie-ubuntu

# Способ 1. Список пакетов
# вернете все ранее установленные программы
# Для выполнения резервной копии 
dpkg --get-selections | grep -v deinstall > backup.txt
# Далее, скопируйте полученный файл в надежное место. 
# Когда система сломается, переустановите ее с установочного носителя, 
# а затем просто выполните команды:
sudo dpkg --set-selections < backup.txt
sudo apt -y update
sudo apt-get dselect-upgrade
# Файл со списком пакетов нужно поместить в текущую папку

# Способ 2. Создание архива
# Более надежно, поскольку вы не просто создаете список 
# установленных программ, а делаете архив из всей файловой системе
sudo tar czf /backup.tar.gz --exclude=/backup.tar.gz --exclude=/home --exclude=/media --exclude=/dev --exclude=/mnt --exclude=/proc --exclude=/sys --exclude=/tmp /
# вы получите полную резервную копию системы в корневом каталоге
# Если система повреждена, вам нужно загрузиться с LiveCD/USB, 
# и примонтировать корневой каталог в /mnt/. 
# Затем подключите носитель с резервной копией и выполните команду для распаковки:
sudo tar xf /run/media/имя_носителя/backup.tar.gz -C /mnt
# перезагрузить компьютер
# Здесь не восстанавливается только загрузчик, восстановить Grub нужно отдельно если он был поврежден

# Способ 3. Резервное копирование в rsync
# Этот способ очень похож на второй, но здесь архив не создается, а данные просто переносятся в другую папку
rsync -aAXv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} / /папка/назначения
# После завершения копирования вам останется отредактировать /etc/fstab и заменить в нем адрес корневого раздела на новый. А также создать новый конфигурационный файл для загрузчика, автоматически или вручную


# Способ 4. Создание образа раздела
# Это самый надежный, но в то же время потребляющий большое количество памяти 
sudo dd if=/dev/sda4 of=~/backup.img
# Здесь /dev/sda4 - это ваш корневой раздел
# чтобы восстановить систему:
sudo dd if=~/backup.img of=/dev/sda4

# Способ 5. Создание Squashfs образа
# Преимущество Squashfs в том, что это полноценная файловая система в одном файле, которую можно очень быстро примонтировать и быстро извлечь нужные файлы
sudo mksquashfs / /root-backup.sqsh -e root-backup.sqsh home media dev run mnt proc sys tmp
# примонтировать созданный образ:
sudo mount /root-backup.sqsh /mnt/ -t squashfs -o loop
# отсюда вы можете извлечь любой файл