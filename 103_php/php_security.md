# Основы безопасности сайта. Конспект

Общие правила:
 - Фильтруйте вход
 - Экранируйте выход

## Входы
- Формы
- Файлы
- Заголовки HTTP ($_SERVER['HTTP_X_FORWARDED_FOR'] и т.д.)
- User agent

## Выходы
- Браузер
- Консоль
- База данных
- ...

## Фильтрация входа

Валидируйте данные. Например, функцией `filter_var`
```php
$email = filter_var($email, FILTER_VALIDATE_EMAIL);
if ($email === false) {
    // ...
}
```
## Популярные угрозы

## 1.SQL-инъекция

SQL-инъекция - внедрение вредоносного кода в запрос к БД.

Как делают:

-   вставка в форму SQL-кода в одинарных кавычках

Как защититься:

-   подготовленные запросы с масками ($db->prepare('... WHERE id=:id ...'))
-   для имён таблиц и столбцов используйте белый список
-   валидируйте загрузку файлов (определять mime-type), пересохраняйте изображения

## 2. XSS (межсайтовый скриптинг)

XSS атака - внедрение вредоносного кода в выдываемую веб-страницу для взаимодействия с сайтом злоумышленника.
На страницу вставляется скрипт, который запускается в браузере.

Как делают:

-   вставка кода в форму (например, тега "script" со своим кодом)
-   вставка кода в адресную строку

Две главные разновидности:
1) Первого порядка - выполняется немедленно
2) Второго порядка - пишется в базу, выполняется потом

Как защититься:

- экранировать HTML, если нужен только текст `htmlspecialchars($content, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8')`;
- Если нужен именно HTML используем библиотеку `HTMLPurifier (http://htmlpurifier.org/)`:
```php
$config = HTMLPurifier_Config::createDefault();
$purifier = new HTMLPurifier($config);
$clean_html = $purifier->purify($dirty_html);
```
-   обработать пользовательский ввод (например, с помощью функций strip_tags(), htmlspecialchars())
-   не выводить на странице необработанные гет-параметры
-   ?? отправлять определённые заголовки для обозначения допустимых ресурсов
-   ?? использовать мета-теги, которые блокируют обращение на сторонние ресурсы
-   использовать HTTP-only куки (не доступны из JavaScript через document.cookie)

Не сохраняйте экранированные данные в базу. Они могут вам понадобиться в исходном виде. К тому же, базе доверять нельзя.

## 3. Проблемы безопасности, связанные с нулевым байтом

Как делают:

```php
$file = $_GET['file']; // "../../etc/passwd\0"
if (file_exists('/home/wwwrun/'.$file.'.php')) {
    // file_exists возвратит true, т.к. /home/wwwrun/../../etc/passwd существует
    include '/home/wwwrun/'.$file.'.php';
    // будет подключён файл /etc/passwd
}

```

Как защититься:

-   проверять данные на использования только разрешённых файлов

## 4. Использование сообщений об ошибках

Сообщение об ошибках могут дать информацию, пригодную для взлома.

Как делают:

-   запустить отладочный механизм, подбирая основные признаки отладки. Пример:

```html
<form method="post" action="attacktarget?errors=Y&amp;showerrors=1&amp;debug=1">
    <input type="hidden" name="errors" value="Y" />
    <input type="hidden" name="showerrors" value="1" />
    <input type="hidden" name="debug" value="1" />
</form>
```

Как защититься:

-   использование функции error_reporting()

## 5. CSRF
Сторонний сайт может отправить форму на ваш сайт от имени пользователя.

Как защититься:
- использовать CSRF-токены (один и тот же токен добавляется в форму и сохр-ся в сессии. После отправки формы, токены сравниваются);
- использовать TLS/SSL
- не использовать GET для изменения состояния приложения:
```php
<img src="/logout" />
// Использование $_REQUEST - то же самое
```

## 6. Инъекция кода
Например, если исползуется `eval()`

Как защититься:
- не использовать `eval()` или использовать после проверки по белому списку

## 7. Небезопасные `include`
```php
require $_GET['type'] . '.php';
```
Как защититься:
- Если нельзя убрать такие `include`, то использовать белый список

## 8. Clickjacking (Взлом кликов)
Обманом заставить пользователя кликнуть на что-то на строннем сайте.
Например, с помощью iframe + opacity:0 (подсовывая интерфейс другого сайта).

Как защититься:
- запретить запихивать сайт в iframe:
```php
header('X-Frame-Options: DENY'); // запретить совсем
header('X-Frame-Options: SAMEORIGIN'); // разрешить только на своем домене
// или через JavaScript ...
```

## 9. Пароли
Злоумышленник может угадать ваш пароль
- перебором
- атакой по словарю
- атакой на основе времени ответа
Пароли могут утечь вместе с БД.

Есть два параметра: 
- Cost - стоимость вычисления хеша (больше 11 - безопасное значение на данный момент) 
- сложность пароля

Как защититься:
- ограничить попытки: `10 попыток с IP в минуту` или `CAPTCHA`(ненадежно)
- вы не должны знать пароль пользователя. Храните хэш
- для хэша не использовать функции `md5, sha1, sha256, sha512` и т.д.
- для хэша использовать как минимум `bcript`
- для генерации случайных чисел использовать: 
    - PHP7 `random_bytes`
    - `LibreSSL`
    - CryptGenRandom (Windows)
    - /dev/random (FreeBSD)
    - /dev/urandom (*nix)
    - Если ничего не получилось, кидаем исключение

## 10. Фиксация сессии
- Дать пользователю заранее известный ID сессии
- Перехват cookie

Как защититься:
- использовать только куки. В php.ini:
```ini
session.use_cookies = 1
session.use_only_cookies = 1
session_cookie_httponly = 1
session.cookie_secure = 1
```
- регенирировать ID сессии при помощи `session_regenerate_id`(true) после логина или смены прав;

## 11. Утечки информации

- Включенный отладочный режим
- Страницы ошибок
- Ответы API
- Системы контроля версий

## Дополнительные рекомендации

- По возможности запускайте всё в песочницах (`sandbox`).
- Запускайте PHP с минимально возможными правами.
- Не забывайте проверять доступ (например, к файлу по URL).
- Сначала запрещайте всё, потом уже разрешайте.
- Обновляйтесь (Linux, Nginx, PHP, СУБД, ...).
- Помните, что зависимости могут быть с уязвимостями.
- `target="_blank"` не безопасен.
- `ImageMagick` не безопасен.
- SMS не безопасны (лучше Push уведомления), например, для 2-хфакторной авторизации.
- XML тоже (XXE).
- Десериализовать опасно.
- Процессоры не безопасны.

## Полезные ссылки на данную тему
- https://www.youtube.com/watch?v=R0pMnVLlX10 - WEB - безопасность: От базовых принципов до особенностей PHP - Александр Макаров
- https://www.php.net/manual/ru/security.php - Руководство по PHP. Безопасность.

## Почитать
- OWASP + testing guide
- Фаулер про безопасность
- Компонент Yii security
- QA на StackExchange
